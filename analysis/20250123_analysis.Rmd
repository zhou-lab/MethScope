---
title: "20240123_analysis"
output: html_document
date: "2025-01-23"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Liu2021 mouse brain

```{r}
library(readxl)
celltype <- read_xlsx("~/cell_type/20220630_Liu2021_mouseBrainWGBS.xlsx")
train <- read.table("~/cell_type/20240322_Liu2021_training_sample.txt",sep="\t")
left_over_cells <- celltype %>% filter(!SampleID %in% train$V1)
output_sample <- left_over_cells$SampleID
#write.table(output_sample,"~/cell_type/20250130_Liu2021.txt",quote=FALSE,col.names = FALSE,row.names = FALSE)
```

yame subset /mnt/isilon/zhou_lab/projects/20220324_SingleCellMeth/mm10/2021_Liu.cg -l ~/cell_type/20250130_Liu2021.txt -o ~/intermediate/20250130_Liu2021.cg
sbatch 20250205_run_model.sh

```{r}
### load prediction result

# Define directory where .rds files are stored
prediction_dir <- "/home/fuh1/intermediate/20250130_Liu2021/"
# List all subset prediction RDS files
rds_files <- list.files(prediction_dir, pattern = "subset_.*_prediction.rds$", full.names = TRUE)
# Load all .rds files and merge them into a single dataframe
prediction_result <- do.call(rbind, lapply(rds_files, function(file) {
  df <- readRDS(file)  # Load .rds file
  return(df)
}))

idx <- match(rownames(prediction_result), celltype$SampleID)
subset_cells_label <- celltype[idx,]
subset_cells_label <- subset_cells_label$MajorType
PlotConfusion(prediction_result,subset_cells_label,log2=F)
#ggsave("~/figures/fuh1/20250130_Liu2021_confusion.pdf",width=6,height=5.5)

PlotF1(prediction_result,subset_cells_label)
#ggsave("~/figures/fuh1/20250130_Liu2021_f1.pdf",width=4,height=6) 
              
# Define directory where .rds files are stored
prediction_dir <- "/home/fuh1/intermediate/20250130_Liu2021/"
# List all subset prediction RDS files
rds_files <- list.files(prediction_dir, pattern = "subset_.*_patterns.rds$", full.names = TRUE)
# Load all .rds files and merge them into a single dataframe
input_pattern <- do.call(rbind, lapply(rds_files, function(file) {
  df <- readRDS(file)  # Load .rds file
  return(df)
}))

umap_plot <- PlotUMAP(input_pattern,prediction_result)
umap_plot[[1]]
ggsave("~/figures/fuh1/20250130_Liu2021_umap.pdf",width=6.5,height=4)


### confidence score plot
prediction_result$actual_label <- subset_cells_label
df <- prediction_result %>%
  mutate(prediction_status = ifelse(prediction_label == actual_label, "Correct", "Incorrect"))

# Create violin plot
ggplot(df, aes(x = prediction_status, y = confidence_score, fill = prediction_status)) +
  geom_boxplot(outlier.shape = NA) +  # Optional: adds boxplot for better visualization
  scale_fill_manual(values = c("Correct" = "#7ac7e2", "Incorrect" = "#e37163")) + 
  labs(title = "", x = "Prediction Status", y = "Confidence Score") +
  theme_bw() + theme(legend.position = "None") + ylim(0,1)+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())
ggsave("~/figures/fuh1/20250130_Liu2021_CI.pdf",width=3,height=3)

### ROC curve for confidence score

thresholds <- seq(0, 1, by = 0.01)
df$correct <- ifelse(df$prediction_status == "Correct",1,0)

roc_df <- lapply(thresholds, function(t) {
  # Create predictions based on threshold
  df <- df %>%
    mutate(predicted = ifelse(confidence_score >= t, 1, 0))
  
  TP <- sum(df$predicted == 1 & df$correct == 1)
  FP <- sum(df$predicted == 1 & df$correct == 0)
  TN <- sum(df$predicted == 0 & df$correct == 0)
  FN <- sum(df$predicted == 0 & df$correct == 1)
  
  TPR <- if ((TP + FN) > 0) TP / (TP + FN) else NA  # Sensitivity
  FPR <- if ((FP + TN) > 0) FP / (FP + TN) else NA  # 1 - Specificity
  
  return(data.frame(threshold = t, TPR = TPR, FPR = FPR))
}) %>% bind_rows()

# Plot ROC curve (FPR vs TPR)
library(DescTools)
roc_df_sorted <- roc_df %>% arrange(FPR)
# Compute AUC
auc <- AUC(x = roc_df_sorted$FPR, y = roc_df_sorted$TPR, method = "trapezoid")

ggplot(roc_df_sorted, aes(x = FPR, y = TPR)) +
  geom_path(size = 1.2,color = "red") +
  geom_abline(linetype = "dashed", color = "gray50") +
  labs(
    title = paste("ROC Curve (AUC =", round(auc, 4), ")"),
    x = "False Positive Rate",
    y = "True Positive Rate"
  ) + theme_bw()+theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())
#ggsave("~/figures/fuh1/20250613_Liu2021_CI_ROC.pdf",width=3,height=3)

sparsity <- read.table("~/intermediate/20250130_Liu2021_summary.txt",header = T)
idx <- match(rownames(prediction_result),sparsity$Query)
sparsity <- sparsity[idx,]
prediction_result$actual_label <- subset_cells_label
df <- prediction_result %>%
  mutate(prediction_status = ifelse(prediction_label == actual_label, "Correct", "Incorrect"))
df$cg <- log10(sparsity$N_query)

ggplot(df, aes(x = prediction_status, y = cg, fill = prediction_status)) +
  geom_boxplot(outlier.shape = NA) +  
  scale_fill_manual(values = c("Correct" = "#7ac7e2", "Incorrect" = "#e37163")) + 
  labs(title = "", x = "Prediction Status", y = "log10 (# CpGs)") +
  theme_bw() + theme(legend.position = "None") + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())
ggsave("~/figures/fuh1/20250130_Liu2021_Sparse.pdf",width=3,height=3)
```

### Fabyanic mouse brain Joint-snhmC-seq

```{r}
reference_pattern <- system.file("extdata", "Liu2021_MouseBrain.cm", package = "MethScope")
input_pattern <- GenerateInput("/home/fuh1/zhou_lab/projects/20220324_SingleCellMeth/mm10/2023_Fabyanic.cg",reference_pattern)

Fabyanic_2024_Pattern.obj <- CreateSeuratObject(counts = t(input_pattern), assay = "DNAm")
VariableFeatures(Fabyanic_2024_Pattern.obj) <- rownames(Fabyanic_2024_Pattern.obj[['DNAm']])
DefaultAssay(Fabyanic_2024_Pattern.obj) <- "DNAm"
Fabyanic_2024_Pattern.obj <- NormalizeData(Fabyanic_2024_Pattern.obj, assay = "DNAm", verbose = FALSE)
Fabyanic_2024_Pattern.obj <- ScaleData(Fabyanic_2024_Pattern.obj, assay = "DNAm", verbose = FALSE)
Fabyanic_2024_Pattern.obj@assays$DNAm@layers$scale.data <- as.matrix(Fabyanic_2024_Pattern.obj@assays$DNAm@layers$counts)

Fabyanic_2024_Pattern.obj <- RunPCA(Fabyanic_2024_Pattern.obj,assay="DNAm",reduction.name = 'mpca', verbose = FALSE)
Fabyanic_2024_Pattern.obj <- FindNeighbors(Fabyanic_2024_Pattern.obj, reduction = "mpca", dims = 1:30)
Fabyanic_2024_Pattern.obj <- FindClusters(Fabyanic_2024_Pattern.obj, verbose = FALSE, resolution = 0.7)
Fabyanic_2024_Pattern.obj <- RunUMAP(Fabyanic_2024_Pattern.obj, reduction = "mpca",  reduction.name = "meth.umap", dims = 1:30,metric="euclidean",min.dist = 0.3,spread=0.7)

prediction_result <- PredictCellType(Liu2021_MouseBrain_P1000,input_pattern,smooth = T)
prediction_result <- prediction_result[match(colnames(Fabyanic_2024_Pattern.obj),rownames(prediction_result)),]
Fabyanic_2024_Pattern.obj$MethScope <- prediction_result$prediction_label

library(readxl)
orig_anno <- read_xlsx("~/cell_type/20230829_Fabyanic2023.xlsx")
orig_anno <- orig_anno[match(rownames(prediction_result),orig_anno$GSM),]
orig_anno_result <- orig_anno$celltype
orig_anno_result[is.na(orig_anno_result)] <- orig_anno$sorting[is.na(orig_anno_result)]

Fabyanic_2024_Pattern.obj$orig_annotation <- orig_anno_result
n_clusters <- length(unique(Fabyanic_2024_Pattern.obj$orig_annotation))
cols <- DiscretePalette(n_clusters, palette = "parade", shuffle = FALSE)
cell_order <- names(Fabyanic_2024_Pattern.obj$orig_annotation)[order(factor(Fabyanic_2024_Pattern.obj$orig_annotation))]

cortex_cells <- orig_anno$GSM[which(orig_anno$tissue=="Cortex" & orig_anno$assay=="snmCseq2")]

subset_obj <- subset(Fabyanic_2024_Pattern.obj, cells = cortex_cells)

subset_obj$orig_annotation <- dplyr::recode(
  subset_obj$orig_annotation,
  "Ex" = "Ex neuron (NeuN⁺/Neurod6⁺)",
  "Inh" = "Inh neuron (NeuN⁺/Neurod6⁻)",
  "NeuN_pos" = "Pan-neuronal (NeuN⁺)",
  "NeuN_neg" = "Nonneuronal (NeuN⁻)"
)

n_clusters <- length(unique(Fabyanic_2024_Pattern.obj$orig_annotation))
cols <- DiscretePalette(n_clusters, palette = "parade", shuffle = FALSE)

ordered_clusters <- c(
 "Nonneuronal (NeuN⁻)","Pan-neuronal (NeuN⁺)",
 "Inh neuron (NeuN⁺/Neurod6⁻)","Ex neuron (NeuN⁺/Neurod6⁺)"
)
cell_order <- names(subset_obj$orig_annotation)[order(factor(subset_obj$orig_annotation, levels = ordered_clusters))]

p1 <- DimPlot(subset_obj, reduction = 'meth.umap', repel = TRUE,group.by = 'orig_annotation', pt.size = 0.7,cols=cols,cells=cell_order)  + NoGrid() + ggtitle("")
p1
#ggsave("~/figures/fuh1/20250414_Haowu_umap_orig.pdf",width=6.5,height=5)

n_clusters <- length(unique(subset_obj$MethScope))
cols <- DiscretePalette(n_clusters, palette = "alphabet", shuffle = FALSE)

p2 <- DimPlot(subset_obj, reduction = 'meth.umap', repel = TRUE,group.by = 'MethScope', pt.size = 0.7,cols=cols)  + NoGrid()
p2
#ggsave("~/figures/fuh1/20250414_Haowu_umap_methscope.pdf",width=5.5,height=5)


### heatmap
Original <- as.character(subset_obj$orig_annotation)
Predicted <- as.character(subset_obj$MethScope)
tab <- table(Original, Predicted)   

mat_counts <- as.matrix(tab)                 
mat_rowpct <- prop.table(tab, margin = 1)    
mat_colpct <- prop.table(tab, margin = 2)    
library(pheatmap)
library(RColorBrewer)

pdf("~/figures/fuh1/20251008_Haowu_prediction.pdf",width=8.5,height=3)
pheatmap(
  mat_counts,                               
  color = colorRampPalette(brewer.pal(9, "YlGnBu"))(100),
  cluster_rows = FALSE,                       
  cluster_cols = FALSE,
  main = "",
  fontsize_number = 7.5,
  angle_col = 45,
  border_color = "black"
)
dev.off()
```

### mouse brain P21 just HPF and isocortex

```{r}
library(readxl)
celltype <- read_xlsx("~/cell_type/20220630_Liu2021_mouseBrainWGBS.xlsx")
celltype <- celltype %>% filter(celltype$MajorRegion %in% c("HPF","Isocortex"))
remove_cells <- names(which(table(celltype$MajorType) < 70))
celltype <- celltype %>% filter(!celltype$MajorType %in% remove_cells)
#output_sample <- celltype$SampleID
#write.table(output_sample,"~/cell_type/20250212_Liu2021hpf.txt",quote=FALSE,col.names = FALSE,row.names = FALSE)
#write.table(celltype, "~/cell_type/20220630_Liu2021_mouseBrainWGBS.tsv", sep = "\t", row.names = FALSE,col.names = TRUE)

sampled_celltype <- celltype %>%
  group_by(MajorType) %>%
  sample_n(70)
output_sample <- sampled_celltype$SampleID
write.table(output_sample,"~/cell_type/20250112_Liu2021_training_sample.txt",quote=FALSE,col.names = FALSE,row.names = FALSE)
```

yame subset /mnt/isilon/zhou_lab/projects/20220324_SingleCellMeth/mm10/2021_Liu.cg -l ~/cell_type/20250112_Liu2021_training_sample.txt -o ~/intermediate/20250212_Liu2021_training.cg

```{r}
reference_pattern <- system.file("extdata", "Liu2021_MouseBrain.cm", package = "MethScope")
input_pattern <- GenerateInput("/home/fuh1/intermediate/20250212_Liu2021_training.cg",reference_pattern)
celltype <- read_xlsx("~/cell_type/20220630_Liu2021_mouseBrainWGBS.xlsx")
sampled_celltype <- celltype$MajorType[match(rownames(input_pattern), celltype$SampleID)]
trained_model <- Input_training(input_pattern,sampled_celltype,cross_validation=T)
saveRDS(trained_model,"/home/fuh1/intermediate/20250212_Liu2021_training_model.rds")
```

### Single cell human atlas

mergeCG2 /home/fuh1/tmp/2025_ecker/results /home/fuh1/zhou_lab/projects/20220324_SingleCellMeth/hg38/2025_Zhou.cg

```{r}
meta <- read.csv("~/tmp/2025_ecker/5kCG100k3C_summary.csv")


### for major type
major_annotation <- read.table("~/tmp/2025_ecker/L1color.tsv",sep = '\t', header = TRUE)
colnames(major_annotation) <- c("majortype","label","anno","color")
meta_updated <- meta %>%
  left_join(major_annotation, by = "majortype") %>%
  select(-majortype) 

cg_idx <- read.table("/home/fuh1/zhou_lab/projects/20220324_SingleCellMeth/hg38/2025_Zhou.cg.idx")
cg_idx <- cg_idx[which(cg_idx$V1 %in% meta_updated$cell),]
meta_updated <- meta_updated[match(cg_idx$V1,meta_updated$cell),]
write.table(meta_updated,"~/cell_type/20250418_eckerhuman_major.tsv",sep="\t",quote = F,col.names = T)

### for subtype 
minor_annotation <- read.table("~/tmp/2025_ecker/subtype_meta.tsv",sep = '\t', header = TRUE)
minor_annotation$celltype_L2_both_abbr <- gsub(" \\d+$", "", minor_annotation$celltype_L2_both_abbr)
colnames(minor_annotation) <- c("subtype","label","anno")
meta_updated <- meta %>%
  left_join(minor_annotation, by = "subtype") %>%
  select(-subtype)

cg_idx <- read.table("/home/fuh1/zhou_lab/projects/20220324_SingleCellMeth/hg38/2025_Zhou.cg.idx")
cg_idx <- cg_idx[which(cg_idx$V1 %in% meta_updated$cell),]
meta_updated <- meta_updated[match(cg_idx$V1,meta_updated$cell),]
```

### merge cell types
```{r}
### merge subtypes by number of cells 
to_merge <- which(table(meta_updated$label) < 300)

meta_updated$label[meta_updated$label == "CLA"] <- "IT L6"
meta_updated$label[meta_updated$label == "CT L6"] <- "IT L6"
meta_updated$label[meta_updated$label == "L6b"] <- "IT L6"

meta_updated$label[meta_updated$label == "DC HT"] <- "Mono"
meta_updated$label[meta_updated$label == "DC"] <- "Mono"
meta_updated$label[meta_updated$label == "Mono HT"] <- "Mono"
macro_lineage <- minor_annotation$label[grepl("Hema Myeloid Macrophage", minor_annotation$anno)]
meta_updated$label[meta_updated$label %in% macro_lineage] <- "Macrophage"
meta_updated <- meta_updated[meta_updated$label != "Hofb",]

endo_lymph_lineage <- minor_annotation$label[grepl("Endo Lymphatic", minor_annotation$anno)]
meta_updated$label[meta_updated$label %in% endo_lymph_lineage] <- "Endo Lym"

endo_vas_lineage <- minor_annotation$label[grepl("Endo Vascular", minor_annotation$anno)]
meta_updated$label[meta_updated$label %in% endo_vas_lineage] <- "Endo Vas"

epi_gas_lineage <- minor_annotation$label[grepl("Epi Gastric", minor_annotation$anno)]
meta_updated$label[meta_updated$label %in% epi_gas_lineage] <- "Epi Gas"

epi_ker_lineage <- minor_annotation$label[grepl("Epi Keratinous/Luminal", minor_annotation$anno)]
meta_updated$label[meta_updated$label %in% epi_ker_lineage] <- "Epi Krt/Lum"

meta_updated <- meta_updated[meta_updated$label != "ET L5",]

fib_edn_lineage <- minor_annotation$label[grepl("Fibro Endoneurial", minor_annotation$anno)]
meta_updated$label[meta_updated$label %in% fib_edn_lineage] <- "Fibro EndN"

fib_gas_lineage <- minor_annotation$label[grepl("Fibro Gastrointestinal", minor_annotation$anno)]
meta_updated$label[meta_updated$label %in% fib_gas_lineage] <- "Fibro GI"

meta_updated$label[meta_updated$label == "Fibro HT Adipo"] <- "Fibro HT"
meta_updated$label[meta_updated$label == "Fibro HT Ven"] <- "Fibro HT"
meta_updated$label[meta_updated$label == "Fibro HT Atr"] <- "Fibro HT"
meta_updated$label[meta_updated$label == "Fibro Myo Myo Co"] <- "Fibro Myo"
meta_updated$label[meta_updated$label == "Fibro Myo Esp"] <- "Fibro Myo"

fib_adr_lineage <- minor_annotation$label[grepl("Fibro Adrenal", minor_annotation$anno)]
meta_updated$label[meta_updated$label %in% fib_adr_lineage] <- "Fibro Adr"

fib_skin_lineage <- minor_annotation$label[grepl("Fibro Skin", minor_annotation$anno)]
meta_updated$label[meta_updated$label %in% fib_skin_lineage] <- "Fibro Sk"

meta_updated <- meta_updated[meta_updated$label != "Gamma",]

meta_updated$label[meta_updated$label == "Gob Ileum"] <- "Gob"
meta_updated$label[meta_updated$label == "Gob Co"] <- "Gob"

meta_updated$label[meta_updated$label == "LAMP5 LHX6"] <- "LAMP5"

Mast_lineage <- minor_annotation$label[grepl("Hema Mast", minor_annotation$anno)]
meta_updated$label[meta_updated$label %in% Mast_lineage] <- "Hema Mast"

meta_updated <- meta_updated[meta_updated$label != "Mus Stem",]

meta_updated$label[meta_updated$label == "NK CD16 Lng"] <- "NK CD16"
meta_updated$label[meta_updated$label == "NK CD16 Bld"] <- "NK CD16"

meta_updated$label[meta_updated$label == "NK CD56 Mix"] <- "NK CD56"
meta_updated$label[meta_updated$label == "NK ILC"] <- "NK CD56"
meta_updated$label[meta_updated$label == "NK CD56 Skn"] <- "NK CD56"
meta_updated$label[meta_updated$label == "NK CD56 Bld"] <- "NK CD56"

Peri_lineage <- minor_annotation$label[grepl("Perivascular", minor_annotation$anno)]
meta_updated$label[meta_updated$label %in% Peri_lineage] <- "Perivascular"

meta_updated$label[meta_updated$label == "PVALB ChC"] <- "PVALB"
meta_updated$label[meta_updated$label == "PVALB BC"] <- "PVALB"

neu_schw_lineage <- minor_annotation$label[grepl("Neu Schwann", minor_annotation$anno)]
meta_updated$label[meta_updated$label %in% neu_schw_lineage] <- "Neu Schw"

meta_updated <- meta_updated[meta_updated$label != "Stem",]
meta_updated <- meta_updated[meta_updated$label != "Trans Amp",]

Tmem_CD4 <- c("Tmem Tfh CD4 Int","Tmem Treg CD4 Skn","Tmem MAIT","Tmem CD4 GI","Tmem CD4 Lng","Tmem Tcm CD4 Bld","Tmem CD4 Skn")
meta_updated$label[meta_updated$label %in% Tmem_CD4] <- "Tmem CD4"
Tmem_CD8 <- c("Tmem Tem CD8 Mix","Tmem CD8 Co","Tmem Tem CD8 Bld","Tmem CD8 Mix","Tmem CD8 Esp","Tmem CD8 Ileum","Tmem gdT CD8 Lng")
meta_updated$label[meta_updated$label %in% Tmem_CD8] <- "Tmem CD8"
write.table(meta_updated,"~/cell_type/20250425_eckerhuman.tsv",sep="\t",quote = F,col.names = T)
```

sbatch ./inst/scripts/GenerateReference.sh

### Single cell human 2025 zhou model training

```{r}
library(dplyr)
meta_updated <- read.table("~/cell_type/20250425_eckerhuman.tsv",sep="\t")
sampled_celltype <- meta_updated %>%
  group_by(label) %>%
  sample_n(70)

output_sample <- sampled_celltype$cell
write.table(output_sample,"~/cell_type/Zhou2025_sample.txt",quote=FALSE,col.names = FALSE,row.names = FALSE)
```

yame subset -l ~/cell_type/Zhou2025_sample.txt 2025_Zhou.cg -o ~/tmp/20240322_SparseM/Zhou2025_train.cg

```{r}
### subtype
meta_updated <- read.table("~/cell_type/20250425_eckerhuman.tsv",sep="\t")
train <- read.table("~/cell_type/Zhou2025_sample.txt",sep="\t")
left_over_cells <- meta_updated %>% filter(!cell %in% train$V1)
output_sample <- left_over_cells$cell
#write.table(output_sample,"~/cell_type/Zhou2025_test.txt",quote=FALSE,col.names = FALSE,row.names = FALSE)

### major type
meta_updated <- read.table("~/cell_type/20250418_eckerhuman_major.tsv",sep="\t")
train <- read.table("~/cell_type/Zhou2025_sample_major.txt",sep="\t")
left_over_cells <- meta_updated %>% filter(!cell %in% train$V1)
output_sample <- left_over_cells$cell
#write.table(output_sample,"~/cell_type/Zhou2025_test_major.txt",quote=FALSE,col.names = FALSE,row.names = FALSE)
```

yame subset -l ~/cell_type/Zhou2025_test.txt /mnt/isilon/zhou_lab/projects/20220324_SingleCellMeth/hg38/2025_Zhou.cg -o ~/tmp/20240322_SparseM/Zhou2025_test.cg

sbatch 20250205_run_model.sh

```{r}
### load prediction result

# Define directory where .rds files are stored
#20250429_Zhou2024
#20250725_Zhou2024
prediction_dir <- "/home/fuh1/intermediate/20250429_Zhou2024/"
# List all subset prediction RDS files
rds_files <- list.files(prediction_dir, pattern = "subset_.*_prediction.rds$", full.names = TRUE)
# Load all .rds files and merge them into a single dataframe
prediction_result <- do.call(rbind, lapply(rds_files, function(file) {
  df <- readRDS(file)  # Load .rds file
  return(df)
}))

idx <- match(rownames(prediction_result), meta_updated$cell)
subset_cells_label <- meta_updated[idx,]
subset_cells_label <- subset_cells_label$label

test <- PlotF1(prediction_result,subset_cells_label)
ggsave("~/figures/fuh1/2025428_Zhou2025_f1.pdf",width=4,height=9)

PlotConfusion(prediction_result, subset_cells_label, log2 = F)
#ggsave("~/figures/fuh1/2025428_Zhou2025_confusion.pdf",width=8,height=7.5)

# Define directory where .rds files are stored
prediction_dir <- "/home/fuh1/intermediate/20250422_Zhou2024/"
# List all subset prediction RDS files
rds_files <- list.files(prediction_dir, pattern = "subset_.*_patterns.rds$", full.names = TRUE)
# Load all .rds files and merge them into a single dataframe
input_pattern <- do.call(rbind, lapply(rds_files, function(file) {
  df <- readRDS(file)  # Load .rds file
  return(df)
}))

umap_plot <- PlotUMAP(input_pattern,prediction_result)
umap_plot[[1]]
ggsave("~/figures/fuh1/20250428_Zho2025_umap.pdf",width=6.5,height=4)


### confidence score plot
prediction_result$actual_label <- subset_cells_label
df <- prediction_result %>%
  mutate(prediction_status = ifelse(prediction_label == actual_label, "Correct", "Incorrect"))

# Create violin plot
ggplot(df, aes(x = prediction_status, y = confidence_score, fill = prediction_status)) +
  geom_boxplot(outlier.shape = NA) +  # Optional: adds boxplot for better visualization
  scale_fill_manual(values = c("Correct" = "#7ac7e2", "Incorrect" = "#e37163")) + 
  labs(title = "", x = "Prediction Status", y = "Confidence Score") +
  theme_bw() + theme(legend.position = "None") + ylim(0,1)+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())
#ggsave("~/figures/fuh1/20250429_Zhou2025_CI.pdf",width=3,height=3)

### ROC curve for confidence score

thresholds <- seq(0, 1, by = 0.01)
df$correct <- ifelse(df$prediction_status == "Correct",1,0)

roc_df <- lapply(thresholds, function(t) {
  # Create predictions based on threshold
  df <- df %>%
    mutate(predicted = ifelse(confidence_score >= t, 1, 0))
  
  TP <- sum(df$predicted == 1 & df$correct == 1)
  FP <- sum(df$predicted == 1 & df$correct == 0)
  TN <- sum(df$predicted == 0 & df$correct == 0)
  FN <- sum(df$predicted == 0 & df$correct == 1)
  
  TPR <- if ((TP + FN) > 0) TP / (TP + FN) else NA  # Sensitivity
  FPR <- if ((FP + TN) > 0) FP / (FP + TN) else NA  # 1 - Specificity
  
  return(data.frame(threshold = t, TPR = TPR, FPR = FPR))
}) %>% bind_rows()


# Plot ROC curve (FPR vs TPR)
library(DescTools)
roc_df_sorted <- roc_df %>% arrange(FPR)
# Compute AUC
auc <- AUC(x = roc_df_sorted$FPR, y = roc_df_sorted$TPR, method = "trapezoid")

ggplot(roc_df_sorted, aes(x = FPR, y = TPR)) +
  geom_path(size = 1.2,color = "red") +
  geom_abline(linetype = "dashed", color = "gray50") +
  labs(
    title = paste("ROC Curve (AUC =", round(auc, 4), ")"),
    x = "False Positive Rate",
    y = "True Positive Rate"
  ) + theme_bw()+theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())
ggsave("~/figures/fuh1/20250613_Zhou2025_CI_ROC.pdf",width=3,height=3)
```

### Nested CV result

```{r}
prediction_dir <- "/home/fuh1/intermediate/MethScope/analysis/models_output_Zhou2025/"
# List all subset prediction RDS files
rds_files <- list.files(
  prediction_dir,
  pattern = "subset_.*_prediction\\.rds$",
  full.names = TRUE,
  recursive = TRUE
)
# Load all .rds files and merge them into a single dataframe
prediction_result <- do.call(rbind, lapply(rds_files, function(file) {
  df <- readRDS(file)  # Load .rds file
  return(df)
}))

library(readxl)
meta_updated <- read_xlsx("/home/fuh1/cell_type/20220630_Liu2021_mouseBrainWGBS.xlsx")
meta_updated <- meta_updated %>% dplyr::filter(SampleID %in% rownames(prediction_result))

idx <- match(rownames(prediction_result), meta_updated$SampleID)
subset_cells_label <- meta_updated[idx,]
subset_cells_label <- subset_cells_label$MajorType

meta_updated <- read.table("/home/fuh1/cell_type/20250425_eckerhuman.tsv",sep="\t")
meta_updated <- meta_updated %>% dplyr::filter(cell %in% rownames(prediction_result))
idx <- match(rownames(prediction_result), meta_updated$cell)
subset_cells_label <- meta_updated[idx,]
subset_cells_label <- subset_cells_label$label

# test <- PlotF1(prediction_result,subset_cells_label)
# ggsave("~/figures/fuh1/20251007_Liu2021_f1.pdf",width=4,height=9)

PlotConfusion(prediction_result, subset_cells_label, log2 = F)
ggsave("~/figures/fuh1/20251107_Zhou2025_confusion.pdf",width=8,height=7.5)

### confidence score plot
prediction_result$actual_label <- subset_cells_label
df <- prediction_result %>%
  mutate(prediction_status = ifelse(prediction_label == actual_label, "Correct", "Incorrect"))

# Create violin plot
ggplot(df, aes(x = prediction_status, y = confidence_score, fill = prediction_status)) +
  geom_boxplot(outlier.shape = NA) +  # Optional: adds boxplot for better visualization
  scale_fill_manual(values = c("Correct" = "#7ac7e2", "Incorrect" = "#e37163")) + 
  labs(title = "", x = "Prediction Status", y = "Confidence Score") +
  theme_bw() + theme(legend.position = "None") + ylim(0,1)+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())
#ggsave("~/figures/fuh1/20250429_Zhou2025_CI.pdf",width=3,height=3)

### ROC curve for confidence score

thresholds <- seq(0, 1, by = 0.01)
df$correct <- ifelse(df$prediction_status == "Correct",1,0)

roc_df <- lapply(thresholds, function(t) {
  # Create predictions based on threshold
  df <- df %>%
    mutate(predicted = ifelse(confidence_score >= t, 1, 0))
  
  TP <- sum(df$predicted == 1 & df$correct == 1)
  FP <- sum(df$predicted == 1 & df$correct == 0)
  TN <- sum(df$predicted == 0 & df$correct == 0)
  FN <- sum(df$predicted == 0 & df$correct == 1)
  
  TPR <- if ((TP + FN) > 0) TP / (TP + FN) else NA  # Sensitivity
  FPR <- if ((FP + TN) > 0) FP / (FP + TN) else NA  # 1 - Specificity
  
  return(data.frame(threshold = t, TPR = TPR, FPR = FPR))
}) %>% bind_rows()


# Plot ROC curve (FPR vs TPR)
library(DescTools)
roc_df_sorted <- roc_df %>% arrange(FPR)
# Compute AUC
auc <- AUC(x = roc_df_sorted$FPR, y = roc_df_sorted$TPR, method = "trapezoid")

ggplot(roc_df_sorted, aes(x = FPR, y = TPR)) +
  geom_path(size = 1.2,color = "red") +
  geom_abline(linetype = "dashed", color = "gray50") +
  labs(
    title = paste("ROC Curve (AUC =", round(auc, 4), ")"),
    x = "False Positive Rate",
    y = "True Positive Rate"
  ) + theme_bw()+theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())
#ggsave("~/figures/fuh1/20250613_Zhou2025_CI_ROC.pdf",width=3,height=3)
```


